<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å¸çš„é»˜å¥‘åº¦é—®ç­”ğŸ¥µ</title>
    <style>
        :root {
            --google-blue: #4285f4;
            --google-red: #ea4335;
            --google-yellow: #fbbc05;
            --google-green: #34a853;
            --gray-bg: #f8f9fa;
        }

        body {
            background-color: var(--gray-bg);
            color: #202124;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding-bottom: 50px;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }

        .rainbow-bar {
            height: 5px; width: 100%;
            background: linear-gradient(to right, var(--google-blue) 25%, var(--google-red) 25% 50%, var(--google-yellow) 50% 75%, var(--google-green) 75%);
            position: fixed; top: 0; left: 0; z-index: 100;
        }

        .container {
            max-width: 650px; width: 92%; background: white;
            margin-top: 60px; padding: 35px; border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 10px 20px rgba(0,0,0,0.05);
        }

        h1 { font-size: 24px; font-weight: 400; text-align: center; margin-bottom: 30px; color: #3c4043; }

        .input-field {
            border: 1px solid #dadce0; border-radius: 8px; padding: 14px 18px;
            font-size: 16px; width: 100%; box-sizing: border-box; margin-bottom: 20px; outline: none;
        }
        .input-field:focus { border: 2px solid var(--google-blue); }

        .btn-group { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }

        .btn {
            border: none; padding: 12px 28px; font-size: 15px; border-radius: 24px;
            cursor: pointer; transition: 0.3s; font-weight: 500;
        }
        .btn-blue { background: var(--google-blue); color: white; }
        .btn-outline { background: white; border: 1px solid #dadce0; color: #5f6368; }
        .btn:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.1); transform: translateY(-1px); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        .question-card {
            border: 1px solid #dadce0; border-radius: 8px; padding: 22px; margin-bottom: 18px;
        }
        .question-text { font-size: 17px; font-weight: 500; margin-bottom: 15px; color: #202124; }
        .options label {
            display: block; margin: 12px 0; cursor: pointer; padding: 10px; border-radius: 6px; border: 1px solid transparent; transition: 0.2s;
        }
        .options label:hover { background: #f8f9fa; border-color: #eee; }
        .options input { margin-right: 12px; transform: scale(1.2); }

        #result { display: none; text-align: center; }
        .score-circle {
            width: 140px; height: 140px; border: 12px solid #eee; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; font-weight: bold; margin: 30px auto; transition: 0.8s;
        }

        .rank-section { margin-top: 30px; padding: 20px; background: #f1f3f4; border-radius: 8px; }
        .hidden { display: none; }
        .status-tag { font-size: 12px; color: #888; margin: 10px 0; font-style: italic; }
    </style>
</head>
<body>

<div class="rainbow-bar"></div>

<div class="container">
    <h1 id="top-title"> å¤§å¸çš„é»˜å¥‘åº¦é—®ç­”ğŸ¥µ </h1>

    <div id="auth-section">
        <input type="text" id="user-id" class="input-field" placeholder="è¾“å…¥ ID ä»¥å¼€å§‹..." onkeydown="if(event.key==='Enter')startQuiz('full')">
        <div class="btn-group">
            <button class="btn btn-outline" onclick="startQuiz('brief')">ç®€ç•¥ç‰ˆ (20é¢˜)</button>
            <button class="btn btn-blue" onclick="startQuiz('full')">å®Œæ•´ç‰ˆ (40é¢˜)</button>
        </div>
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn btn-outline" onclick="showRankingDirectly()">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
        </div>
    </div>

    <div id="quiz-section" class="hidden">
        <div id="questions-container"></div>
        <button type="button" class="btn btn-blue" style="width:100%; margin-top:20px;" onclick="calculateScore()">æäº¤æˆ‘çš„ç­”æ¡ˆ</button>
    </div>

    <div id="result">
        <h2 id="result-title"> æµ‹è¯•ç»“æœ </h2>
        <div class="score-circle" id="score-display">0%</div>
        <p id="result-text" style="font-size: 18px; color: #3c4043; line-height: 1.6; padding: 0 10px;"></p>
        
        <div id="sync-status" class="status-tag">æ­£åœ¨åŒæ­¥æ•°æ®...</div>

        <div class="rank-section">
            <h3>ğŸ† å®æ—¶åˆ†æ•°æ’è¡Œæ¦œ</h3>
            <div id="rank_list">åŠ è½½ä¸­...</div>
        </div>
        
        <button class="btn btn-outline" style="margin-top: 25px;" onclick="location.reload()">é‡æ–°æµ‹è¯•</button>
    </div>
</div>

<script> // å½©è›‹ï¼šæ§åˆ¶å°è¾“å…¥ yours()
    const API_BASE = "https://quiz-backend-1-lrmy.onrender.com";

    const qData = [
        { id: "q1", q: "å¥¥åˆ©å¥¥è¿˜æ˜¯è¶£å¤šå¤šï¼Ÿ", opts: ["å¥¥åˆ©å¥¥", "è¶£å¤šå¤š"], a: "6Laj5aSa5aSa" },
        { id: "q2", q: "ç©¿ä¸‰è§’è¿˜æ˜¯å¹³è§’ï¼Ÿ", opts: ["ä¸‰è§’", "å¹³è§’"], a: "5LiJ6KeS" },
        { id: "q3", q: "Gemini è¿˜æ˜¯ DeepSeekï¼Ÿ", opts: ["Gemini", "DeepSeek"], a: "R2VtaW5p" },
        { id: "q4", q: "å–œæ¬¢çŒ«è¿˜æ˜¯ç‹—ï¼Ÿ", opts: ["çŒ«", "ç‹—"], a: "54uX" },
        { id: "q5", q: "å†¬å¤©è¿˜æ˜¯å¤å¤©ï¼Ÿ", opts: ["å†¬å¤©", "å¤å¤©"], a: "5aSP5aSp" },
        { id: "q6", q: "è–¯æ¡è˜¸ç•ªèŒ„é…±å—ï¼Ÿ", opts: ["ä¼š", "ä¸ä¼š"], a: "5Lya" }, 
        { id: "q7", q: "å‡ºé—¨å¸¦ä¸å¸¦å……ç”µå®ï¼Ÿ", opts: ["å¸¦", "ä¸å¸¦"], a: "5bim" },
        { id: "q8", q: "èƒŒåŒ…é‡Œä¼šä¸ä¼šå¤‡æœ‰è¯•çº¸ï¼Ÿ", opts: ["ä¼š", "ä¸ä¼š"], a: "5Lya" },
        { id: "q9", q: "æ—©ç¡æ—©èµ·è¿˜æ˜¯ç»å¸¸ç†¬å¤œï¼Ÿ", opts: ["æ—©ç¡æ—©èµ·", "ç»å¸¸ç†¬å¤œ"], a: "5pep552h5pep6LW3" },
        { id: "q10", q: "æ— çº¸åŒ–å­¦ä¹ ï¼Ÿ", opts: ["æ˜¯", "å¦"], a: "5ZCm" },
        { id: "q11", q: "ç§’å›æ¶ˆæ¯è¿˜æ˜¯å‡†å¤‡å¥½å†å›ï¼Ÿ", opts: ["ç§’å›", "å‡†å¤‡å¥½"], a: "5YeG5aSH5aW9" },
        { id: "q12", q: "å–œæ¬¢çœ‹æ—¥å‡ºè¿˜æ˜¯æ—¥è½ï¼Ÿ", opts: ["æ—¥å‡º", "æ—¥è½"], a: "5pel5Ye6" },
        { id: "q13", q: "Lady Gaga è¿˜æ˜¯ Taylor Swiftï¼Ÿ", opts: ["Lady Gaga", "Taylor Swift"], a: "TGFkeSBHYWdh" },
        { id: "q14", q: "åº“è¿ªè¿˜æ˜¯ç‘å¹¸ï¼Ÿ", opts: ["åº“è¿ª", "ç‘å¹¸"], a: "5bqT6L+q" },
        { id: "q15", q: "åƒä¸åƒé¦™èœï¼Ÿ", opts: ["åƒ", "ä¸åƒ"], a: "5ZCD" },
        { id: "q16", q: "å–œæ¬¢æ‹é£æ™¯è¿˜æ˜¯äººåƒï¼Ÿ", opts: ["é£æ™¯", "äººåƒ"], a: "5Lq65YOP" },
        { id: "q17", q: "æ—…è¡Œæå‰è®¡åˆ’è¿˜æ˜¯éšæ—¶å‡ºå‘ï¼Ÿ", opts: ["æå‰è®¡åˆ’", "éšæ—¶å‡ºå‘"], a: "5o+Q5YmN6K6h5YiS" },
        { id: "q18", q: "æ‰‹æœºå¸¦å£³å—ï¼Ÿ", opts: ["å¸¦", "ä¸å¸¦"], a: "5bim" },
        { id: "q19", q: "æ‰‹å†²å’–å•¡è¿˜æ˜¯æ„å¼ï¼Ÿ", opts: ["æ‰‹å†²", "æ„å¼"], a: "5oSP5byP" },
        { id: "q20", q: "EDM è¿˜æ˜¯ Jazzï¼Ÿ", opts: ["EDM", "Jazz"], a: "RURN" },
        { id: "q21", q: "æŠ’æƒ…æµè¡Œè¿˜æ˜¯æ‘‡æ»šï¼Ÿ", opts: ["æµè¡Œ", "æ‘‡æ»š"], a: "5rWB6KGM" },
        { id: "q22", q: "è€å…‹è¿˜æ˜¯å®‰å¾·ç›ï¼Ÿ", opts: ["è€å…‹", "å®‰å¾·ç›"], a: "5a6J5b63546b" },
        { id: "q23", q: "ç ´äº§å§å¦¹orç»å‘½æ¯’å¸ˆï¼Ÿ", opts: ["ç ´äº§å§å¦¹", "ç»å‘½æ¯’å¸ˆ"], a: "56C05Lqn5aeQ5aa5" }, 
        { id: "q24", q: "é»‘è‰²è¿˜æ˜¯ç™½è‰²ï¼Ÿ", opts: ["é»‘è‰²", "ç™½è‰²"], a: "6buR6Imy" }, 
        { id: "q25", q: "è°ˆè¿‡å¥³æœ‹å‹å—ï¼Ÿ", opts: ["æœ‰", "å¦"], a: "5ZCm" },
        { id: "q26", q: "æ—…è¡Œæ›´åœ¨æ„åƒè¿˜æ˜¯ä½ï¼Ÿ", opts: ["åƒ", "ä½"], a: "5ZCD" },
        { id: "q27", q: "é™ˆå¥•è¿…è¿˜æ˜¯å«å…°ï¼Ÿ", opts: ["é™ˆå¥•è¿…", "å«å…°"], a: "5Y2r5YWw" },
        { id: "q28", q: "ä»¥åè¿˜æœ‰å¯èƒ½å…»å® ç‰©å—ï¼Ÿ", opts: ["ä¼š", "ä¸ä¼š"], a: "5Lya" },
        { id: "q29", q: "ç›¸ä¿¡ç¥ç§˜å­¦å—ï¼Ÿ", opts: ["ç›¸ä¿¡", "ä¸ç›¸ä¿¡"], a: "55u45L+h" },
        { id: "q30", q: "ç›¸ä¿¡é£æ°´å­¦å—ï¼Ÿ", opts: ["ç›¸ä¿¡", "ä¸ç›¸ä¿¡"], a: "55u45L+h" },
        { id: "q31", q: "ä¼šä»¥äº¤å‹ä¸ºä¸»è¦ç›®çš„è€Œæ—…è¡Œå—ï¼Ÿ", opts: ["ä¼š", "ä¸ä¼š"], a: "5Lya" },
        { id: "q32", q: "æ—…è¡Œæ›´å–œæ¬¢Soloè¿˜æ˜¯ç»„é˜Ÿï¼Ÿ", opts: ["Solo", "ç»„é˜Ÿ"], a: "U29sbw==" },
        { id: "q33", q: "èµ·é£æ—¶æ›´å€¾å‘ X è¿˜æ˜¯ç”µæŠ¥ï¼Ÿ", opts: ["X", "ç”µæŠ¥"], a: "WA==" },
        { id: "q34", q: "æ”¯æŒè€ƒç ”è¿˜æ˜¯è€ƒå…¬ï¼Ÿ", opts: ["è€ƒç ”", "è€ƒå…¬"], a: "6ICD56CU" },
        { id: "q35", q: "æ”¯æŒåŠ¨ä¿ï¼Ÿ", opts: ["æ”¯æŒ", "ä¸æ”¯æŒ"], a: "5pSv5oyB" },
        { id: "q36", q: "æ‹ç‰©ç™–ï¼Ÿ", opts: ["æœ‰", "æ²¡æœ‰"], a: "5pyJ" },
        { id: "q37", q: "ä½ è§‰å¾—30å²åœ¨äººç”Ÿä¸­ç®—æ—©å—ï¼Ÿ", opts: ["æ—©", "ä¸æ—©"], a: "5pep" },
        { id: "q38", q: "ä½ å·²ç»æµç‹¬ç«‹äº†å—ï¼Ÿ", opts: ["å·²ç‹¬ç«‹", "æš‚æœª"], a: "5pqC5pyq" },
        { id: "q39", q: "ä½ å±äºé«˜æ•æ„Ÿäººç¾¤å—ï¼Ÿ", opts: ["æ˜¯", "å¦"], a: "5piv" },
        { id: "q40", q: "å¯¹ç¤¾ä¼šå­¦ï¼Œå¿ƒç†å­¦æˆ–è¯­è¨€å­¦æ„Ÿå…´è¶£å—ï¼Ÿ", opts: ["æ˜¯", "å¦"], a: "5piv" }
    ];

    let currentSet = [];
    let finalScore = 0;

    window.onload = function() {
        const savedId = localStorage.getItem('quiz_user_id');
        if (savedId) document.getElementById('user-id').value = savedId;
        loadRanking();
        startHeartbeat(); // å¯åŠ¨é˜²ä¼‘çœ å¿ƒè·³
    };

    function safeAtob(str) {
        try { return decodeURIComponent(escape(window.atob(str))).trim(); } 
        catch (e) { return window.atob(str).trim(); }
    }

    // --- ã€å½©è›‹å›å½’ã€‘æ§åˆ¶å°è¾“å…¥ yours() è‡ªåŠ¨å¡«å……æ­£ç¡®ç­”æ¡ˆ ---
    window.yours = function() {
        if (currentSet.length === 0) return "âŒ å°šæœªå¼€å§‹ç­”é¢˜";
        currentSet.forEach(item => {
            const correctVal = safeAtob(item.a);
            const radios = document.querySelectorAll(`input[name="${item.id}"]`);
            radios.forEach(r => {
                if (r.value.trim() === correctVal) r.checked = true;
            });
        });
        console.log("çœŸé¢ç›®å·²è¢«æ­æ™“...");
        return "âœ… ç­”æ¡ˆå·²å¡«å…¥";
    };

    function startQuiz(mode) {
        const id = document.getElementById('user-id').value.trim();
        if (!id) { alert("è¾“å…¥idå†å¼€å§‹å§"); return; }
        localStorage.setItem('quiz_user_id', id);
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('quiz-section').classList.remove('hidden');
        let shuffled = [...qData].sort(() => Math.random() - 0.5);
        currentSet = mode === 'brief' ? shuffled.slice(0, 20) : shuffled;
        renderQuestions();
    }

    function renderQuestions() {
        const container = document.getElementById('questions-container');
        container.innerHTML = currentSet.map((item, i) => `
            <div class="question-card">
                <div class="question-text">${i+1}. ${item.q}</div>
                <div class="options">
                    ${item.opts.map(o => `<label><input type="radio" name="${item.id}" value="${o.trim()}"> ${o}</label>`).join('')}
                </div>
            </div>
        `).join('');
        window.scrollTo(0, 0);
    }

    function calculateScore() {
        let scoreCount = 0;
        let answeredCount = 0;
        currentSet.forEach(item => {
            const sel = document.querySelector(`input[name="${item.id}"]:checked`);
            if (sel) {
                answeredCount++;
                if (sel.value === safeAtob(item.a)) scoreCount++;
            }
        });
        if (answeredCount < currentSet.length) {
            alert(`è¿˜æœ‰ ${currentSet.length - answeredCount} é“é¢˜æ²¡å†™å®Œï¼`);
            return;
        }
        finalScore = Math.round((scoreCount / currentSet.length) * 100);
        showResult(finalScore);
        autoSubmit(document.getElementById('user-id').value, finalScore);
    }

    function showResult(s) {
        document.getElementById('quiz-section').classList.add('hidden');
        document.getElementById('result').style.display = 'block';
        const circle = document.getElementById('score-display');
        circle.innerText = s + "%";
        const text = document.getElementById('result-text');
        if (s >= 80) text.innerText = "æˆ‘ä»¬æ˜¯å¤©é€ åœ°è®¾çš„å§å¦¹ã€‚";
        else if (s >= 60) text.innerText = "æˆ–è®¸æˆ‘æœ‰è·Ÿä½ èŠè¿‡æˆ‘çš„æ€§ç™–å¥½ã€‚";
        else text.innerText = "æˆ‘ä»¬æœ‰äº›ä¸åŒçˆ±å¥½ï¼Œä½†å¯ä»¥èŠèŠã€‚";
    }

    function autoSubmit(uid, score) {
        const status = document.getElementById('sync-status');
        fetch(`${API_BASE}/submit`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: uid, score: score })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                status.innerText = "æ•°æ®å·²åŒæ­¥è‡³æ—¥å¿— âœ…";
                loadRanking();
            }
        })
        .catch(err => {
            console.error("åŒæ­¥å¤±è´¥", err);
            status.innerText = "åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ âš ï¸";
        });
    }

    function loadRanking() {
        fetch(`${API_BASE}/ranking`)
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('rank_list');
                list.innerHTML = data.map((item, i) => `
                    <p style="border-bottom: 1px dashed #eee; padding: 5px 0;">
                        ${i+1}. <b>${item.user_id}</b> â€” ${item.score}%
                    </p>
                `).join('') || "æš‚æ— æ•°æ®";
            });
    }

    function showRankingDirectly() {
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('result').style.display = 'block';
        loadRanking();
    }

    // é˜²ä¼‘çœ ï¼šæ¯ 10 åˆ†é’Ÿè¸¢ä¸€ä¸‹åç«¯
    function startHeartbeat() {
        setInterval(() => {
            fetch(`${API_BASE}/health`).then(() => console.log("ğŸ’“ Keep-alive"));
        }, 10 * 60 * 1000);
    }
</script>
</body>
</html>
